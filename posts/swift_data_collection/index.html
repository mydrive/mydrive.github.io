<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>iOS Device Motion Data Collection Using Swift</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="How MyDrive Solutions collects iOS device motion data using Swift and how we managed to avoid running out of memory">
    <meta name="author" content="MyDrive Solutions">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
<link href='/assets/stylesheets/bootstrap.min-88238289010db19359d2181e634e95cd.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/style-e81fa375b231bedf6cb2dbc6653570cc.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/google_prettify/sons-of-obsidian-afb0925bfa2d994f17dab93e13fbf999.css' type='text/css' rel='stylesheet' media='all'>
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  <link rel="shortcut icon" href="/assets/media/favicon.ico">
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">MyDrive Engineering</a>
          <ul class="nav">
              
                <li><a href="/archive">Archive</a></li>
              
              
                <li><a href="/tags">Tags</a></li>
              
              
                <li><a href="/categories">Categories</a></li>
              
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
          by <strong>Carlos Alonso Perez</strong>
  <p>Software Engineer</p>
  <p><a href="https://twitter.com/calonso" target="_blank">@calonso</a></p>

<div class="page-header">
  <h1>iOS Device Motion Data Collection Using Swift </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>2014-10-08</strong>
    </div>
    <div class="content">
      <p>Here at MyDrive we are completely data-driven and as such we need to collect
as much data as possible. This data is then analysed by our data scientists and/or
used for Machine Learning purposes. To collect all that data we have designed and created our
own iOS data collection app (a.k.a. the iOS awesome app) that silently records
all our movements (lovely, isn&#39;t it?).</p>

<p>Now let&#39;s get to the technical part. The application has been written in Apple&#39;s
brand new programming language: Swift, and we started developing it since it was
in beta version, so that means that parts of our codebase had to be rewritten to
adopt the incoming changes from any new released beta.</p>

<p>That has been my first hands-on time with Swift and I have to say that I like it.
Although I used to like it more in one of the betas than in the current first release.
The idea of writing</p>

<pre><code class="swift">if var v = some_method() {

}
</code></pre>

<p>or</p>

<pre><code class="swift">if some_var? {

}
</code></pre>

<p>rather than:</p>

<pre><code class="swift">var v = some_method()
if v != nil {

}
</code></pre>

<p>was, IMO, really a cleaner way of doing nil variable testing, but, for some reason
Apple decided to remove that feature.</p>

<p>Apart from that detail, I think that the language has some &#39;must haves&#39; and cool
features such as closures support, tuples, multiple return values, variable
type inference and functional programming patterns. It also has some which are
not so cool like optionals, dodgy casting errors, different parameter names from
within or outside functions, and the fact that it is still very young and things
are likely to change in the short/mid term.</p>

<p>Finished giving my first impressions on Swift, let&#39;s now move on to the so called
<code>ios awesome app</code> and particularly to the most technically interesting part of
it that is how we managed to be able to record accelerometer data for hours
without running out of memory, because, as you have guessed, our first approach
was to store all the accelerometer observations in an array structure and then,
when finished recording, dump it for gzipping and submitting to the cloud storage.</p>

<p>That &#39;all in memory/brute force&#39; approach worked not bad for a while, given that
we were collecting data at 1Hz frequency, but when we required to start recording
data at higher frequencies (30 and 60 Hz), problems soon appeared.</p>

<p>After spotting the cause of the issue, we decided to create a custom <code>NSOperation</code>
meant to run outside the main <code>NSOperationQueue</code> that, from time to time simply
dumps the contents of the array holding the accelerometer data to a file in disk
through a <code>NSOutputStream</code> and that worked fine except for the fact that after some
time using the app we realised that the last batch wasn&#39;t fully dumped
(failed to wait for the dumping queue to finish before reading for gzipping).</p>

<p>Once solved, the code looks more or less like this:</p>

<pre><code class="swift">func addDataRow(...) {
  data.append(...)

  if data.count &gt;= 300 {
    let toBeDump = data
    data = [Row]()
    dumpArray(toBeDump)
  }
}
</code></pre>

<p>This piece of code simply appends data to an array and when it&#39;s reaches a
size, copies it to another variable and clears it to avoid it becoming too large.</p>

<pre><code class="swift">func dumpArray(data: [Row]!) {
  let op = CSVDumpOperation(file: filePath, data: data)
  if lastOp != nil &amp;&amp; !lastOp!.finished {
    op.addDependency(lastOp)
  }
  lastOp = op
  dumpQueue.addOperation(op)
}
</code></pre>

<p>The copy is then given to a custom <code>NSOperation</code> to be dump to disk outside the
main operation queue. Those operations are executed sequentially to avoid data
being disordered.</p>

<p>The dump operation looks like this:</p>

<pre><code class="swift">class CSVDumpOperation: NSOperation {

  let data = [Row]()
  let os : NSOutputStream

  init(file: String, data: [Row]) {
    os = NSOutputStream(toFileAtPath: file, append: true)
    os.open()

    super.init()

    self.data = data
  }

  override func main() {
    for row in data {
      let rowStr = &quot;\(row.x),\(row.y),\(row.z)...\n&quot;
      if let rowData = rowStr.dataUsingEncoding(NSUTF8StringEncoding, allowLossyConversion: false) {
        let bytes = UnsafePointer&lt;UInt8&gt;(rowData.bytes)
        os.write(bytes, maxLength: rowData.length)
      }
    }

    os.close()
  }
}
</code></pre>

<p>This <code>CSVDumpOperation</code> simply opens a <code>NSOutputStream</code> to the file and writes there
the csv formatted contents of the given array.</p>

<p>And that&#39;s it!, with this simple approach for this simple application we intend
to collect hundreds of hours of different activities for further analysis.</p>

    </div>
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      <li>
        <a href="/categories#development-ref">development <span>9</span></a>
      </li>
      <li>
        <a href="/categories#programming-ref">programming <span>5</span></a>
      </li>
    </ul>
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      <li>
        <a href="/tags#iOS-ref">iOS <span>1</span></a>
      </li>
      <li>
        <a href="/tags#Swift-ref">Swift <span>1</span></a>
      </li>
      <li>
        <a href="/tags#memory management-ref">memory management <span>1</span></a>
      </li>
      <li>
        <a href="/tags#data collection-ref">data collection <span>1</span></a>
      </li>
    </ul>
    <hr>
    <div class="pagination">
      <ul>
          <li class="prev"><a href="/posts/shellshock" title="Shellshock - MyDrive&#39;s Actions">&larr; Previous</a></li>

          <li><a href="/archive">Archive</a></li>

          <li class="next"><a href="/posts/security-update-2014-10-17" title="Security Updates (POODLE and OpenSSL)">Next &rarr;</a></li>
      </ul>
    </div>
    <hr>
    
  </div>
</div>


      </div>

      <hr>
      <div class="footer">
        <p>&copy; <a href="http://mydrivesolutions.com" target="_blank">MyDrive Solutions Limited</a> 2014
          with help from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>

    </div> <!-- /container -->

    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32835100-1']);
  _gaq.push(['_trackPageview']);
  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    
  </body>
</html>
